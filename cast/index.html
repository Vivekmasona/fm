<!doctype html>


<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#00ffcc">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="application-name" content="Bihar FM 007">
<meta name="apple-mobile-web-app-title" content="Bihar FM 007">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root {
  --accent: #00ffcc;
  --bg1: #080808;
  --bg2: #121212;
  --grad: linear-gradient(135deg, #00ffcc, #0077ff);
}
body {
  margin: 0;
  padding: 25px;
  font-family: "Segoe UI", sans-serif;
  background: var(--bg1);
  color: #fff;
  text-align: center;
}
h1 {
  font-size: 26px;
  background: var(--grad);
  -webkit-background-clip: text;
  color: transparent;
  margin-bottom: 15px;
}
button, select {
  padding: 10px 14px;
  margin: 6px;
  border-radius: 8px;
  border: none;
  font-size: 16px;
  cursor: pointer;
  transition: 0.2s;
}
button { background: var(--grad); color: #fff; }
button:hover { opacity: 0.85; }
button:disabled { background: #333; color: #777; cursor: not-allowed; }
select { background: #111; color: #fff; border: 1px solid #00ffcc55; }

#broadcastBtn {
  margin: 20px auto;
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: #222;
  border: 2px solid var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: var(--accent);
  position: relative;
  transition: 0.3s;
}
#broadcastBtn.active { background: #0f0; color: #000; animation: pulse 1.5s infinite; }
#broadcastBtn.inactive { background: #f00; color: #fff; }
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(0,255,128,0.6); }
  70% { box-shadow: 0 0 0 20px rgba(0,255,128,0); }
  100% { box-shadow: 0 0 0 0 rgba(0,255,128,0); }
}

#playlist {
  background: #101010;
  width: 90%;
  max-width: 450px;
  margin: 15px auto;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 0 10px #00ffcc33;
  text-align: left;
  max-height: 120px; /* Show only 2 songs */
  overflow-y: auto;
}
.song {
  display: flex;
  align-items: center;
  padding: 6px 8px;
  border-radius: 8px;
  cursor: pointer;
  margin: 4px 0;
  background: #181818;
  transition: 0.2s;
}
.song:hover { background: #00ffcc22; }
.song.active { background: var(--grad); color: #000; }
.song img {
  width: 45px; height: 45px; border-radius: 6px; margin-right: 10px;
  object-fit: cover;
}

.file-label {
  background: #111;
  padding: 10px 14px;
  border-radius: 8px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #00ffcc55;
}
.file-label:hover { background: #1a1a1a; }

#audioBtns {
  margin-top: 15px;
  display: flex;
  justify-content: center;
  gap: 20px;
}
.audio-btn {
  background: none;
  border: none;
  color: var(--accent);
  font-size: 24px;
  cursor: pointer;
}
.audio-btn:hover { color: #0f0; }

#seekContainer {
  width: 80%;
  max-width: 400px;
  margin: 15px auto;
}
#seekBar {
  width: 100%;
  accent-color: var(--accent);
  height: 6px;
  cursor: pointer;
  border-radius: 4px;
  background: #222;
}
#status { margin-top: 15px; font-weight: bold; }
#listeners { margin-top: 5px; color: #aaa; }

#audio { display: none; }
</style>



<h1>ðŸŽ§ Bihar FM 007 | Pro Broadcast</h1>

<label for="file" class="file-label"><i class="fa-solid fa-file-audio"></i> Select Songs</label>
<input id="file" type="file" accept="audio/*" multiple hidden />

<br />
<button id="change" disabled><i class="fa-solid fa-music"></i> Change Song</button>
<button id="micToggle" disabled><i class="fa-solid fa-microphone"></i> Mic</button>
<select id="quality">
  <option value="32000" />Low
  <option value="64000" selected />Medium
  <option value="128000" />High
  <option value="192000" />Ultra
</select>

<div id="broadcastBtn" class="inactive"><i class="fa-solid fa-wifi"></i></div>

<div id="playlist"></div>

<div id="seekContainer">
  <input type="range" id="seekBar" value="0" min="0" max="100" step="0.1" />
</div>

<div id="audioBtns">
  <button id="prev" class="audio-btn"><i class="fa-solid fa-backward"></i></button>
  <button id="playPause" class="audio-btn"><i class="fa-solid fa-play"></i></button>
  <button id="repeat" class="audio-btn"><i class="fa-solid fa-repeat"></i></button>
  <button id="next" class="audio-btn"><i class="fa-solid fa-forward"></i></button>
</div>

<div id="status">Connecting...</div>
<div id="listeners">Listeners: 0</div>
<audio id="player"></audio>

<script>
const WS = "wss://fmconnector.onrender.com";
const socket = new WebSocket(WS);

const fileEl = document.getElementById("file");
const player = document.getElementById("player");
const playlistEl = document.getElementById("playlist");
const statusEl = document.getElementById("status");
const countEl = document.getElementById("listeners");
const micBtn = document.getElementById("micToggle");
const broadcastBtn = document.getElementById("broadcastBtn");
const qualitySel = document.getElementById("quality");
const playPause = document.getElementById("playPause");
const nextBtn = document.getElementById("next");
const prevBtn = document.getElementById("prev");
const repeatBtn = document.getElementById("repeat");
const seekBar = document.getElementById("seekBar");

let pcs = new Map();
let localStream = null;
let currentTrack = null;
let micStream = null;
let micEnabled = false;
let peerCount = 0;
let currentBitrate = 64000;
let playlist = [];
let index = 0;
let repeat = false;
let playing = false;

// âœ… WebSocket setup
socket.onopen = () => {
  socket.send(JSON.stringify({ type: "register", role: "broadcaster" }));
  setStatus("Connected âœ…");
};
socket.onmessage = async (e) => {
  const msg = JSON.parse(e.data);
  if (msg.type === "listener-joined") {
    peerCount++;
    countEl.textContent = "Listeners: " + peerCount;
    makePeer(msg.id);
  }
  if (msg.type === "answer") {
    const pc = pcs.get(msg.from);
    if (pc) await pc.setRemoteDescription(msg.payload);
  }
  if (msg.type === "candidate") {
    const pc = pcs.get(msg.from);
    if (pc) try { await pc.addIceCandidate(msg.payload); } catch {}
  }
  if (msg.type === "peer-left") {
    peerCount = Math.max(0, peerCount - 1);
    countEl.textContent = "Listeners: " + peerCount;
  }
};
function setStatus(msg, ok = true) {
  statusEl.textContent = msg;
  statusEl.style.color = ok ? "#0f0" : "#f33";
}

// âœ… Broadcast toggle
broadcastBtn.onclick = async () => {
  if (broadcastBtn.classList.contains("inactive")) {
    broadcastBtn.classList.remove("inactive");
    broadcastBtn.classList.add("active");
    startBroadcast();
  } else {
    broadcastBtn.classList.remove("active");
    broadcastBtn.classList.add("inactive");
    stopBroadcast();
  }
};

async function startBroadcast() {
  if (!playlist.length) return alert("Select songs first!");
  index = 0;
  await playSong(index);
  micBtn.disabled = false;
  document.getElementById("change").disabled = false;
  setStatus("ðŸŽµ Broadcasting started");
}
function stopBroadcast() {
  pcs.forEach(pc => pc.close());
  pcs.clear();
  peerCount = 0;
  countEl.textContent = "Listeners: 0";
  setStatus("ðŸ›‘ Broadcast stopped", false);
}

// âœ… Playlist
fileEl.onchange = () => {
  playlist = Array.from(fileEl.files);
  playlistEl.innerHTML = "";
  playlist.forEach((f, i) => {
    const div = document.createElement("div");
    div.className = "song";
    div.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/727/727245.png"><div>${f.name}</div>`;
    div.onclick = () => playSong(i);
    playlistEl.appendChild(div);
  });
};

// âœ… Playback controls
playPause.onclick = async () => {
  if (playing) { player.pause(); playing = false; }
  else { await player.play(); playing = true; }
  playPause.innerHTML = playing ? `<i class="fa-solid fa-pause"></i>` : `<i class="fa-solid fa-play"></i>`;
};
nextBtn.onclick = () => { if (index + 1 < playlist.length) playSong(++index); };
prevBtn.onclick = () => { if (index > 0) playSong(--index); };
repeatBtn.onclick = () => {
  repeat = !repeat;
  repeatBtn.style.color = repeat ? "#0f0" : "#00ffcc";
};

// âœ… Play song
async function playSong(i) {
  index = i;
  const file = playlist[i];
  player.src = URL.createObjectURL(file);
  await player.play();
  playing = true;
  playPause.innerHTML = `<i class="fa-solid fa-pause"></i>`;

  document.querySelectorAll(".song").forEach(e => e.classList.remove("active"));
  playlistEl.children[i].classList.add("active");

  const stream = player.captureStream();
  localStream = stream;
  currentTrack = stream.getAudioTracks()[0];
  updateAllPeersTrack();
}

// âœ… Seek bar update
player.ontimeupdate = () => {
  if (!isNaN(player.duration)) {
    seekBar.value = (player.currentTime / player.duration) * 100;
  }
};
seekBar.oninput = () => {
  if (!isNaN(player.duration)) {
    player.currentTime = (seekBar.value / 100) * player.duration;
  }
};
player.onended = () => {
  if (repeat) playSong(index);
  else if (index + 1 < playlist.length)
    setTimeout(() => playSong(index + 1), 1000);
};

// âœ… Mic Mixing
async function toggleMic() {
  if (!micEnabled) {
    try {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const ctx = new AudioContext();
      const dest = ctx.createMediaStreamDestination();
      const music = ctx.createMediaStreamSource(localStream);
      const mic = ctx.createMediaStreamSource(micStream);
      const g1 = ctx.createGain(), g2 = ctx.createGain();
      g1.gain.value = 0.1; g2.gain.value = 0.9;
      music.connect(g1).connect(dest);
      mic.connect(g2).connect(dest);
      localStream = dest.stream;
      currentTrack = localStream.getAudioTracks()[0];
      await updateAllPeersTrack();
      micEnabled = true;
      micBtn.innerHTML = "ðŸ”‡ Mic Off";
      setStatus("ðŸŽ¤ Mic ON (90% voice / 10% music)");
    } catch(e) { setStatus("Mic access denied", false); }
  } else {
    micStream.getTracks().forEach(t=>t.stop());
    const ctx = new AudioContext();
    const dest = ctx.createMediaStreamDestination();
    const src = ctx.createMediaStreamSource(player.captureStream());
    src.connect(dest);
    localStream = dest.stream;
    currentTrack = localStream.getAudioTracks()[0];
    await updateAllPeersTrack();
    micEnabled = false;
    micBtn.innerHTML = "ðŸŽ™ï¸ Mic";
    setStatus("ðŸŽµ Full music mode");
  }
}
micBtn.onclick = toggleMic;

// âœ… Quality control
qualitySel.onchange = e => updateAudioQuality(e.target.value);
async function updateAudioQuality(bitrate) {
  currentBitrate = bitrate;
  for (const pc of pcs.values()) {
    const s = pc.getSenders().find(x => x.track?.kind === "audio");
    if (!s) continue;
    const p = s.getParameters();
    if (!p.encodings) p.encodings = [{}];
    p.encodings[0].maxBitrate = parseInt(bitrate);
    await s.setParameters(p);
  }
  setStatus(`ðŸŽš Audio quality: ${bitrate/1000} kbps`);
}

// âœ… Peer functions
async function updateAllPeersTrack() {
  for (const pc of pcs.values()) {
    const s = pc.getSenders().find(x => x.track?.kind === "audio");
    if (s) await s.replaceTrack(currentTrack);
  }
}
async function makePeer(id) {
  const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
  pcs.set(id, pc);
  if (currentTrack) pc.addTrack(currentTrack, localStream);
  pc.onicecandidate = e => {
    if (e.candidate)
      socket.send(JSON.stringify({ type:"candidate", target:id, payload:e.candidate }));
  };
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.send(JSON.stringify({ type:"offer", target:id, payload:pc.localDescription }));
}
</script>

</!doctype>
