<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FM Dashboard</title>
  <style>
    body { font-family: sans-serif; background: #0a0a0a; color: white; text-align: center; }
    h1 { color: #4af; }
    .controls { margin-top: 20px; }
    select, input[type="file"], input[type="text"] { margin: 10px; padding: 8px; font-size: 1rem; }
    audio { width: 90%; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>üéõÔ∏è FM Control Room</h1>
  <div class="controls">
    <input type="file" id="fileInput" accept="audio/*" />
    <select id="quality">
      <option value="low">Low (64kbps)</option>
      <option value="medium" selected>Medium (128kbps)</option>
      <option value="high">High (256kbps)</option>
    </select>
    <input type="text" id="titleInput" placeholder="Enter song title..." />
    <button id="startBtn">Start Stream</button>
  </div>
  <audio id="preview" controls></audio>

  <script>
    const socket = new WebSocket(
      (location.protocol === "https:" ? "wss://" : "ws://") + location.host
    );

    let mediaRecorder;
    let fileURL;

    socket.onopen = () => {
      socket.send(JSON.stringify({ type: "register", role: "broadcaster" }));
    };

    const fileInput = document.getElementById("fileInput");
    const preview = document.getElementById("preview");
    const startBtn = document.getElementById("startBtn");
    const titleInput = document.getElementById("titleInput");
    const quality = document.getElementById("quality");

    let currentFile;

    fileInput.onchange = () => {
      currentFile = fileInput.files[0];
      preview.src = URL.createObjectURL(currentFile);
    };

    startBtn.onclick = async () => {
      if (!currentFile) return alert("Please select an audio file first!");

      const title = titleInput.value.trim() || currentFile.name;
      const bitrate = quality.value;

      const audioCtx = new AudioContext();
      const src = audioCtx.createMediaElementSource(preview);
      const dest = audioCtx.createMediaStreamDestination();
      src.connect(dest);
      src.connect(audioCtx.destination);

      const stream = dest.stream;

      let bitrateVal = bitrate === "low" ? 64000 : bitrate === "medium" ? 128000 : 256000;

      mediaRecorder = new MediaRecorder(stream, {
        mimeType: "audio/webm",
        audioBitsPerSecond: bitrateVal,
      });

      mediaRecorder.ondataavailable = async (e) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64data = btoa(
            new Uint8Array(reader.result)
              .reduce((data, byte) => data + String.fromCharCode(byte), "")
          );
          socket.send(
            JSON.stringify({ type: "audio-update", title, chunk: base64data })
          );
        };
        reader.readAsArrayBuffer(e.data);
      };

      mediaRecorder.start(1000);
      preview.play();
    };
  </script>
</body>
</html>
