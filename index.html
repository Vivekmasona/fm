<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FM Listener</title>
  <style>
    body { font-family: sans-serif; background:#111; color:#fff; text-align:center; }
    h1 { color: #4af; }
    audio { width: 90%; margin-top: 20px; }
    .title { font-size: 1.2rem; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ðŸŽ§ Live FM Listener</h1>
  <div class="title" id="title">Waiting for broadcast...</div>
  <audio id="player" controls autoplay></audio>

  <script>
    const socket = new WebSocket(
      (location.protocol === "https:" ? "wss://" : "ws://") + location.host
    );

    const audio = document.getElementById("player");
    const titleEl = document.getElementById("title");

    let source = null;
    let ctx = null;

    socket.onopen = () => {
      socket.send(JSON.stringify({ type: "register", role: "listener" }));
    };

    socket.onmessage = async (e) => {
      const msg = JSON.parse(e.data);
      if (msg.type === "stream-chunk") {
        if (!ctx) {
          ctx = new (window.AudioContext || window.webkitAudioContext)();
          source = ctx.createBufferSource();
        }
      }
      if (msg.type === "audio-update") {
        titleEl.textContent = msg.title || "Untitled Stream";
        const blob = new Blob([Uint8Array.from(atob(msg.chunk), c => c.charCodeAt(0))], { type: "audio/webm" });
        const url = URL.createObjectURL(blob);
        audio.src = url;
      }
      if (msg.type === "meta") {
        titleEl.textContent = msg.title;
      }
    };
  </script>
</body>
</html>
