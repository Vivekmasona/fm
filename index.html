<!doctype html>  
<html lang="en">  
<head>  
<meta charset="UTF-8">  
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">  
<title>BiharFM ‚Äù Live</title>  
  
<!-- ‚úÖ PWA Setup -->  
<link rel="manifest" href="manifest.json">  
<meta name="theme-color" content="#ffff00">  
<link rel="apple-touch-icon" href="192.png">  
<script>  
if ('serviceWorker' in navigator) {  
  navigator.serviceWorker.register('sw.js')  
    .then(()=>console.log('‚úÖ Service Worker Registered'))  
    .catch(console.error);  
}  
</script>  
  
<!-- ‚ö° Performance Hints -->  
<meta http-equiv="Cache-Control" content="max-age=3600, must-revalidate">  
<link rel="preconnect" href="wss://fmconnector.onrender.com">  
<link rel="preload" as="image" href="https://i.ibb.co/Xrv9T57F/happy-woman-listening-music-with-headphones-932695-5594.jpg">  
  
<style>  
:root {  
  --accent:#ff2b2b;  
  --text:#fff;  
  --muted:#bbb;  
  --bg:#0a0a0f;  
  --card:#151520;  
}  
*{box-sizing:border-box;margin:0;padding:0;}  
body{  
  font-family:'Poppins',sans-serif;  
  background:var(--bg);  
  color:var(--text);  
  height:100vh;width:100vw;  
  overflow:hidden;  
  display:flex;  
  flex-direction:column;  
  -webkit-user-select:none;  
  user-select:none;  
  touch-action:manipulation;  
}  
.cover {width:100%;height:100%;position:relative;overflow:hidden;}  
.cover img {width:100%;height:100%;object-fit:cover;transform:translateY(-20px);filter:blur(1px);scale:1.05;}  
.cover::after {content:"";position:absolute;inset:0;background:linear-gradient(to top,rgba(0,255,100,0.25) 40%,rgba(0,0,0,0.45) 60%,rgba(0,255,150,0.2) 100%);mix-blend-mode:overlay;z-index:2;}  
.top{flex:0 0 40%;display:flex;flex-direction:column;justify-content:space-between;align-items:center;padding:10px 20px 0 20px;z-index:2;}  
header{width:100%;display:flex;justify-content:space-between;align-items:center;}  
.logo{font-size:20px;font-weight:700;}  
.logo span:first-child{color:#fff;}  
.logo span:last-child{color:var(--accent);}  
.time{font-size:15px;color:var(--muted);}  
.liveStatus{display:flex;align-items:center;gap:6px;color:var(--muted);}  
.liveDot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent);position:relative;}  
.liveDot::after{content:"";position:absolute;inset:0;border-radius:50%;background:rgba(255,0,0,0.4);animation:ripple 1.4s ease-out infinite;}  
@keyframes ripple{0%{transform:scale(1);opacity:1;}100%{transform:scale(2.5);opacity:0;}}  
.song-info{text-align:center;margin-top:20px;}  
.song-info h2{font-size:22px;font-weight:600;}  
.song-info p{font-size:14px;color:var(--muted);margin-top:4px;}  
.controls{display:flex;justify-content:center;align-items:center;gap:35px;margin-bottom:20px;}  
.btn{width:60px;height:60px;border-radius:18px;background:var(--card);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:inset 2px 2px 5px rgba(255,255,255,0.05),4px 4px 10px rgba(0,0,0,0.4);transition:0.25s;}  
.btn:hover{transform:scale(1.08);}  
.btn svg{width:26px;height:26px;fill:var(--text);}  
.play{position:relative;width:78px;height:78px;border-radius:50%;background:linear-gradient(90deg,#ff3c3c,#ff8888);box-shadow:0 0 20px rgba(255,0,0,0.4);}  
.play svg{fill:#fff;width:80px;height:80px;}  
.play.playing::after{content:"";position:absolute;inset:0;border-radius:50%;background:rgba(255,50,50,0.4);animation:wavePulse 1.5s infinite ease-out;z-index:-1;}  
@keyframes wavePulse{0%{transform:scale(1);opacity:0.8;}100%{transform:scale(2.4);opacity:0;}}  
.bottom{flex:1;position:relative;overflow:hidden;}  
.bottom::before{content:"";position:absolute;top:-50px;left:0;width:100%;height:100px;background:var(--bg);border-radius:0 0 100% 100%;z-index:1;}  

/* Retry overlay */  
#retryOverlay {position:fixed;inset:0;background:rgba(0,0,0,0.8);color:#fff;font-size:18px;display:none;justify-content:center;align-items:center;flex-direction:column;z-index:100;}  
#retryOverlay button {margin-top:15px;padding:10px 20px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-size:16px;cursor:pointer;}  
#retryOverlay button:hover {background:#ff5555;}  

/* Longpress popup */  
.longpress-popup {position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(0.9);min-width:280px;max-width:90%;background:linear-gradient(180deg,#121218 0%,#17171a 100%);border:1px solid rgba(255,255,255,0.04);padding:14px 16px;border-radius:12px;z-index:10010;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;flex-direction:column;gap:8px;color:var(--text);transition:transform .15s ease,opacity .15s ease;opacity:0;}  
.longpress-popup.show {display:flex;transform:translate(-50%,-50%) scale(1);opacity:1;}  
.longpress-popup h4{margin:0;font-size:15px;font-weight:600;}  
.longpress-popup p{margin:0;font-size:13px;color:var(--muted);}  
.longpress-popup input{margin-top:8px;width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text);font-size:14px;outline:none;}  
.lp-actions{display:flex;gap:8px;margin-top:10px;justify-content:flex-end;}  
.lp-actions button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;}  
.lp-cancel{background:transparent;color:#ccc;border:1px solid rgba(255,255,255,0.03);}  
.lp-submit{background:linear-gradient(90deg,#ff3c3c,#ff8888);color:#fff;box-shadow:0 6px 20px rgba(255,0,0,0.12);}  
@keyframes shake{0%{transform:translateX(0);}25%{transform:translateX(-6px);}50%{transform:translateX(6px);}75%{transform:translateX(-4px);}100%{transform:translateX(0);}}  
.longpress-popup.wrong{animation:shake .35s;}  

/* Install popup */  
.install-popup{position:fixed;bottom:-200px;left:0;width:100%;background:#151520;border-radius:18px 18px 0 0;color:#fff;box-shadow:0 -2px 20px rgba(0,0,0,0.6);padding:18px 20px 24px;transition:bottom 0.4s ease;z-index:9999;display:flex;flex-direction:column;align-items:center;text-align:center;}  
.install-popup.show{bottom:0;}  
.install-popup h3{font-size:18px;font-weight:600;margin-bottom:6px;color:#fff;}  
.install-popup p{font-size:14px;color:#ccc;margin-bottom:14px;}  
.install-btn{background:linear-gradient(90deg,#ff3c3c,#ff8888);color:#fff;border:none;outline:none;border-radius:30px;padding:10px 24px;font-weight:600;font-size:15px;cursor:pointer;box-shadow:0 0 15px rgba(255,0,0,0.4);}  
.install-btn:hover{transform:scale(1.05);}  
.close-install{position:absolute;top:10px;right:18px;color:#888;cursor:pointer;font-size:20px;}  
</style>  

  
</head>
<body>

<!-- INSTALL POPUP -->
<div class="install-popup" id="installPopup">
  <div class="close-install" onclick="hideInstallPopup()">√ó</div>
  <h3>üìª Install BiharFM App</h3>
  <p>Listen live anytime with one tap!</p>
  <button class="install-btn" id="installBtn">Install Now</button>
</div>

<div class="top">
  <header>
    <div class="logo"><span>Bihar</span><span>FM</span></div>
    <div class="time" id="timeCounter">00:00</div>
    <div class="liveStatus"><div class="liveDot"></div><span id="connText">Connecting‚Ä¶</span></div>
  </header>

  <div class="song-info">
    <h2 id="songTitle">Bihar FM</h2>
    <p id="artistName">By Vivekfy</p>
  </div>

  <div class="controls">
    <div class="btn" id="shareBtn"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a2.48 2.48 0 000-1.39l7.02-4.11A2.5 2.5 0 1014.5 5a2.5 2.5 0 00.04.42L7.52 9.53a2.5 2.5 0 100 4.94l7.02 4.11a2.5 2.5 0 102.46-2.5z"/></svg></div>
    <div class="btn play" id="playPauseBtn">
      <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none;"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>
    </div>
    <div class="btn" id="chatBtn"><svg viewBox="0 0 24 24"><path d="M20.52 3.48A11.85 11.85 0 0012 0C5.37 0 0 5.37 0 12a11.8 11.8 0 001.68 6.05L0 24l6.14-1.6A11.88 11.88 0 0012 24c6.63 0 12-5.37 12-12 0-3.2-1.25-6.22-3.48-8.52z"/></svg></div>
  </div>
</div>

<div class="bottom">
  <div class="cover">
    <img id="coverImg" src="https://i.ibb.co/Xrv9T57F/happy-woman-listening-music-with-headphones-932695-5594.jpg" alt="Cover">
  </div>
</div>

<!-- Retry Overlay -->
<div id="retryOverlay">
  <div>Connection lost</div>
  <button id="retryBtn">Tap to Retry</button>
</div>

<!-- Longpress popup -->
<div class="longpress-popup" id="lpPopup">
  <h4>Dashboard</h4>
  <p>Enter Correct Password</p>
  <input id="lpInput" type="password" placeholder="Password" />
  <div class="lp-actions">
    <button class="lp-cancel" id="lpCancel">Cancel</button>
    <button class="lp-submit" id="lpSubmit">Open</button>
  </div>
</div>

<audio id="player" autoplay></audio>

<script>
/*
 listener.html script
 - long-press password gate (vk007)
 - unified listener / mini-host behavior
 - responds to server messages: pair-created, pair-removed, sync, offer, answer, candidate, metadata
*/
const WS_URL = "wss://fmconnector.onrender.com";
const player = document.getElementById("player");
const connText = document.getElementById("connText");
const playBtn = document.getElementById("playPauseBtn");
const playIcon = document.getElementById("playIcon");
const pauseIcon = document.getElementById("pauseIcon");
const songTitle = document.getElementById("songTitle");
const artistName = document.getElementById("artistName");
const coverImg = document.getElementById("coverImg");
const timeCounter = document.getElementById("timeCounter");
const retryOverlay = document.getElementById("retryOverlay");
const retryBtn = document.getElementById("retryBtn");

// long press popup elements
const lpPopup = document.getElementById("lpPopup");
const lpInput = document.getElementById("lpInput");
const lpCancel = document.getElementById("lpCancel");
const lpSubmit = document.getElementById("lpSubmit");

let ws = null;
let pc = null; // for receiving stream if plain listener
let miniPcMap = new Map(); // if mini-host: memberId -> RTCPeerConnection
let role = "listener";
let pairId = null;
let members = [];
let myId = null;

let reconnectTimeout = null, reconnecting = false, retryCount = 0;
const PAIR_PASSWORD = "vk007";

// time counter update
setInterval(()=>{
  if(player && !isNaN(player.currentTime)){
    const t=Math.floor(player.currentTime);
    const m=Math.floor(t/60).toString().padStart(2,"0");
    const s=(t%60).toString().padStart(2,"0");
    timeCounter.textContent=`${m}:${s}`;
  }
},1000);

function connectWS(){
  reconnecting = false;
  retryOverlay.style.display="none";
  ws = new WebSocket(WS_URL);
  connText.textContent="Connecting";

  ws.onopen = () => {
    ws.send(JSON.stringify({ type: "register", role: "listener" }));
    connText.textContent = "Waiting for stream";
    retryCount = 0;
  };

  ws.onmessage = async (e) => {
    const msg = JSON.parse(e.data);

    if (msg.type === "pair-created") {
      pairId = msg.pairId;
      role = msg.role;
      members = msg.members || [];
      console.log("Pair created", pairId, role, members);

      if (role === "mini-host") {
        connText.textContent = "Mini-host (preparing)";
        setupMiniHost(pairId, members);
      } else if (role === "paired-listener") {
        connText.textContent = "Paired listener (waiting for mini-host)";
      }
    }

    if (msg.type === "pair-removed") {
      pairId = null;
      role = "listener";
      members = [];
      connText.textContent = "Pair removed. Waiting...";
      try { ws.send(JSON.stringify({ type: "register", role: "listener" })); } catch(e){}
    }

    if (msg.type === "sync") {
      if (typeof msg.currentTime === "number" && Math.abs(player.currentTime - msg.currentTime) > 0.5) {
        try { player.currentTime = msg.currentTime; } catch(e){}
      }
      if (msg.playing) player.play().catch(()=>{}); else player.pause();
    }

    if (msg.type === "metadata") {
      if (msg.title) songTitle.textContent = msg.title;
      if (msg.artist) artistName.textContent = msg.artist;
      if (msg.cover) coverImg.src = msg.cover;
    }

    if (msg.type === "offer") {
      // offer from mini-host -> we are plain listener
      if (pc) { try { pc.close(); } catch (e) {} pc = null; }
      pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302"}] });
      pc.ontrack = (ev) => {
        player.srcObject = ev.streams[0];
        player.play().catch(()=>{});
        connText.textContent = "Live";
      };
      pc.onicecandidate = (ev) => { if (ev.candidate) ws.send(JSON.stringify({ type: "candidate", target: msg.from, payload: ev.candidate })); };
      await pc.setRemoteDescription(msg.payload);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({ type: "answer", target: msg.from, payload: answer }));
    }

    if (msg.type === "answer") {
      const from = msg.from;
      const pcOut = miniPcMap.get(from);
      if (pcOut) {
        try { await pcOut.setRemoteDescription(msg.payload); } catch (e) { console.warn(e); }
      }
    }

    if (msg.type === "candidate") {
      const from = msg.from;
      if (role === "mini-host") {
        const out = miniPcMap.get(from);
        if (out) try { await out.addIceCandidate(msg.payload); } catch (e) {}
      } else {
        if (pc) try { await pc.addIceCandidate(msg.payload); } catch (e) {}
      }
    }
  };

  ws.onclose = () => handleDisconnect();
  ws.onerror = () => handleDisconnect();
}

function handleDisconnect(){
  if (reconnecting) return;
  reconnecting = true;
  connText.textContent="Reconnecting...";
  if(pc){pc.close();pc=null;}
  if(reconnectTimeout) clearTimeout(reconnectTimeout);
  retryCount++;
  if(retryCount <= 5){ reconnectTimeout=setTimeout(()=>connectWS(),3000); }
  else retryOverlay.style.display="flex";
}
retryBtn.onclick=()=>{retryCount=0;connectWS();};

// mini-host setup
async function setupMiniHost(pairIdValue, membersList) {
  pairId = pairIdValue;
  members = membersList || [];
  await ensurePlayerCanPlay();

  const stream = player.captureStream ? player.captureStream() : null;
  if (!stream) {
    console.warn("captureStream not supported");
    return;
  }

  // create outbound peer connections to other members (excluding self)
  // members are server ids; mini-host initiates offers
  const peers = members.filter(id => id !== myId);
  for (const memberId of peers) {
    const pcOut = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
    miniPcMap.set(memberId, pcOut);

    stream.getTracks().forEach(t => {
      try { pcOut.addTrack(t, stream); } catch (e) {}
    });

    pcOut.onicecandidate = (ev) => {
      if (ev.candidate && ws?.readyState === ws.OPEN) {
        ws.send(JSON.stringify({ type: "candidate", target: memberId, payload: ev.candidate, pairId }));
      }
    };

    try {
      const offer = await pcOut.createOffer();
      await pcOut.setLocalDescription(offer);
      ws.send(JSON.stringify({ type: "offer", target: memberId, payload: offer, pairId }));
    } catch (err) {
      console.warn("mini-host offer fail", err);
    }
  }
}

async function ensurePlayerCanPlay() {
  try {
    player.muted = true;
    await player.play();
    player.pause();
    player.muted = false;
  } catch (e) {}
}

// long-press unlock
let lpTimer = null;
function openPopup() { lpPopup.classList.add("show"); lpInput.focus(); }
function closePopup() { lpPopup.classList.remove("show"); }
document.body.addEventListener("touchstart", () => { lpTimer = setTimeout(openPopup, 1500); });
document.body.addEventListener("touchend", () => { clearTimeout(lpTimer); });

lpCancel.onclick = () => closePopup();
lpSubmit.onclick = () => {
  if (lpInput.value === PAIR_PASSWORD) {
    lpPopup.classList.remove("show");
    if (!ws || ws.readyState !== WebSocket.OPEN) connectWS();
  } else {
    lpPopup.classList.add("wrong");
    setTimeout(() => lpPopup.classList.remove("wrong"), 400);
  }
};

// play/pause UI
playBtn.onclick = async () => { if (player.paused) await player.play(); else player.pause(); };
player.addEventListener("pause",()=>{ playIcon.style.display="block"; pauseIcon.style.display="none"; });
player.addEventListener("play",()=>{ playIcon.style.display="none"; pauseIcon.style.display="block"; });

// share / chat
document.getElementById("shareBtn")?.onclick = () => { if (navigator.share) navigator.share({ title: "BiharFM Live", text: "Listen now", url: location.href }); };
document.getElementById("chatBtn")?.onclick = () => { window.open("https://wa.me/?text=üéß Listen BiharFM Live ‚ûú " + encodeURIComponent(location.href), "_blank"); };

// init
myId = "client-" + Math.floor(Math.random()*1000000);
connectWS();
</script>

</body>
</html>
