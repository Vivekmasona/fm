<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ðŸŽ§ FM Radio</title>
<style>
  body{background:#000;color:#fff;font-family:sans-serif;text-align:center;padding:20px;}
  h2{font-size:24px;margin:10px;}
  #title{opacity:.8;}
  audio{width:90%;margin-top:30px;border-radius:10px;}
</style>
</head>
<body>
<h2>ðŸŽ§ FM Radio</h2>
<p id="title">Waiting for stream...</p>
<audio id="audio" controls autoplay></audio>

<script>
const ws = new WebSocket("wss://fmconnector.onrender.com");
let pc, audio = document.getElementById("audio");

ws.onopen = () => ws.send(JSON.stringify({ type: "register", role: "listener" }));

ws.onmessage = async (e) => {
  const msg = JSON.parse(e.data);

  if (msg.type === "offer") {
    pc = new RTCPeerConnection();

    pc.ontrack = ev => {
      audio.srcObject = ev.streams[0];
      audio.play().catch(()=>console.log("Autoplay blocked"));
    };

    pc.onicecandidate = ev => {
      if (ev.candidate)
        ws.send(JSON.stringify({ type: "candidate", payload: ev.candidate }));
    };

    await pc.setRemoteDescription(msg.payload);
    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);
    ws.send(JSON.stringify({ type: "answer", payload: ans }));
  }

  if (msg.type === "candidate" && pc) {
    await pc.addIceCandidate(msg.payload);
  }

  if (msg.type === "sync") {
    document.getElementById("title").textContent = msg.title;
    if (audio && audio.currentTime < msg.time - 1) {
      audio.currentTime = msg.time;
    }
  }
};
</script>
</body>
</html>
