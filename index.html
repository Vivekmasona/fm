<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>🎶 FM Live</title>
<style>
body{background:#000;color:#0f0;text-align:center;font-family:sans-serif;}
h2{margin-top:20px}
#meta{margin-top:10px;font-size:20px;}
audio{width:90%;margin-top:15px;}
</style>
</head>
<body>
<h2>🔴 Live FM</h2>
<div id="meta">⏳ Waiting...</div>
<audio id="player" autoplay controls></audio>

<script>
const WS = location.origin.replace(/^http/, "ws");
const ws = new WebSocket(WS);
const player = document.getElementById("player");
const meta = document.getElementById("meta");
let pc = null;

ws.onopen = () => ws.send(JSON.stringify({type:"register",role:"listener"}));

ws.onmessage = async e => {
  const msg = JSON.parse(e.data);

  if(msg.type==="offer"){
    pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    pc.ontrack = ev => player.srcObject = ev.streams[0];
    pc.onicecandidate = e=>{
      if(e.candidate) ws.send(JSON.stringify({type:"candidate",target:msg.from,payload:e.candidate}));
    };
    await pc.setRemoteDescription(msg.payload);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({type:"answer",target:msg.from,payload:pc.localDescription}));
  }

  if(msg.type==="candidate" && pc){
    try{await pc.addIceCandidate(msg.payload);}catch{}
  }

  if(msg.type==="meta-update"){
    const { title, time } = msg.payload;
    const mins = Math.floor(time/60), secs = Math.floor(time%60).toString().padStart(2,'0');
    meta.innerHTML = `🎵 ${title || 'Untitled'} <br> 🔴 Live • ${mins}:${secs}`;
  }
};
</script>
</body>
</html>
