<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>BiharFM â€” Live Beat Reactive</title>
<style>
body {
  margin: 0;
  font-family: "Poppins", sans-serif;
  background: #0a0a0f;
  color: white;
  overflow: hidden;
  height: 100vh;
  display: flex;
  flex-direction: column;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 25px;
}
.logo span:first-child { color: white; }
.logo span:last-child { color: #ff2b2b; }
.liveDot {
  width: 10px; height: 10px; border-radius: 50%;
  background: #ff2b2b;
  box-shadow: 0 0 10px #ff2b2b;
}
.cover {
  flex: 1;
  position: relative;
  overflow: hidden;
}
.cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: blur(8px);
  transform: scale(1.05);
  transition: transform 0.1s ease-out;
}
.cover::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(to top, rgba(0, 255, 100, 0.25), rgba(0, 0, 0, 0.45));
  mix-blend-mode: overlay;
  z-index: 2;
}
.center {
  position: absolute;
  top: 40%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  z-index: 3;
}
.center h2 { font-size: 24px; margin-bottom: 8px; }
.center p { color: #bbb; }

.play {
  width: 80px; height: 80px;
  background: linear-gradient(90deg, #ff3c3c, #ff8888);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 0 20px rgba(255,0,0,0.4);
  cursor: pointer;
  margin: 20px auto;
}
.play svg { width: 40px; height: 40px; fill: white; }
.play.playing::after {
  content:"";
  position:absolute;inset:0;border-radius:50%;
  background:rgba(255,50,50,0.4);
  animation:wave 1.5s infinite ease-out;
}
@keyframes wave {
  0%{transform:scale(1);opacity:0.8;}
  100%{transform:scale(2.3);opacity:0;}
}
</style>
</head>
<body>

<header>
  <div class="logo"><span>Bihar</span><span>FM</span></div>
  <div class="liveDot"></div>
</header>

<div class="cover">
  <img id="coverImg" src="https://images.unsplash.com/photo-1525182008055-f88b95ff7980?q=80&w=800&auto=format&fit=crop">
  <div class="center">
    <h2 id="songTitle">Live Radio</h2>
    <p id="artistName">BiharFM Stream</p>
    <div class="play" id="playBtn">
      <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>
    </div>
  </div>
</div>

<audio id="player" autoplay></audio>

<script>
const WS_URL = "wss://fmconnector.onrender.com";
const player = document.getElementById("player");
const playBtn = document.getElementById("playBtn");
const playIcon = document.getElementById("playIcon");
const pauseIcon = document.getElementById("pauseIcon");
const coverImg = document.getElementById("coverImg");
let pc = null, analyser = null, audioCtx = null, dataArray = null;
let lastScale = 1.05;

function connectWS(){
  const socket = new WebSocket(WS_URL);
  socket.onopen = ()=> socket.send(JSON.stringify({type:"register",role:"listener"}));
  socket.onmessage = async e=>{
    const msg = JSON.parse(e.data);
    if(msg.type === "offer"){
      pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
      pc.ontrack = ev=>{
        player.srcObject = ev.streams[0];
        player.play();
        setupAnalyser(ev.streams[0]); // connect analyser to WebRTC stream
      };
      await pc.setRemoteDescription(msg.payload);
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      socket.send(JSON.stringify({type:"answer",target:msg.from,payload:ans}));
    }
    if(msg.type === "candidate" && pc){
      await pc.addIceCandidate(msg.payload).catch(()=>{});
    }
    if(msg.type === "metadata"){
      if(msg.title) document.getElementById("songTitle").textContent = msg.title;
      if(msg.artist) document.getElementById("artistName").textContent = msg.artist;
      if(msg.cover) coverImg.src = msg.cover;
    }
  };
}

function setupAnalyser(stream){
  audioCtx = new AudioContext();
  const source = audioCtx.createMediaStreamSource(stream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  const bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);
  source.connect(analyser);
  animateBeat();
}

function animateBeat(){
  requestAnimationFrame(animateBeat);
  if(!analyser) return;
  analyser.getByteFrequencyData(dataArray);
  const avg = dataArray.reduce((a,b)=>a+b,0) / dataArray.length;
  const scale = 1.05 + Math.min(avg/250, 0.15);
  lastScale = lastScale * 0.8 + scale * 0.2;
  coverImg.style.transform = `scale(${lastScale.toFixed(3)})`;
}

playBtn.onclick = ()=>{
  if(player.paused){
    player.play();
    playBtn.classList.add("playing");
    playIcon.style.display="none";
    pauseIcon.style.display="block";
  }else{
    player.pause();
    playBtn.classList.remove("playing");
    playIcon.style.display="block";
    pauseIcon.style.display="none";
  }
};

connectWS();
</script>
</body>
</html>
