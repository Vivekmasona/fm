<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>BiharFM ‚Äù Live</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffff00">
<link rel="apple-touch-icon" href="192.png">

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
}
</script>

<style>
:root {
  --accent:#ff2b2b;
  --text:#fff;
  --muted:#bbb;
  --bg:#0a0a0f;
  --card:#151520;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:Poppins,sans-serif;
  background:var(--bg);
  color:var(--text);
  height:100vh;width:100vw;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  user-select:none;
}
.liveStatus{display:flex;align-items:center;gap:6px;color:#ccc}
.liveDot{width:10px;height:10px;border-radius:50%;background:red;box-shadow:0 0 10px red}
.longpress-popup{
  position:fixed;
  inset:0;
  background:#000c;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.longpress-popup.show{display:flex}
.lp-box{
  background:#151520;
  padding:18px;
  border-radius:12px;
  width:280px;
}
.lp-box h4{margin-bottom:6px}
.lp-box input{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:8px;
  border:none;
  outline:none;
}
.lp-actions{display:flex;gap:8px;margin-top:12px;justify-content:flex-end}
.lp-actions button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.lp-submit{background:#ff3c3c;color:#fff}
.lp-cancel{background:#333;color:#ccc}
#retryOverlay{
  position:fixed;inset:0;
  background:#000c;
  color:#fff;
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:9998;
}
</style>
</head>

<body>

<div class="top">
<header style="display:flex;justify-content:space-between;align-items:center;padding:12px">
<div class="logo"><b>Bihar</b><span style="color:red">FM</span></div>

<div class="liveStatus">
<div class="liveDot"></div>
<span id="connText">Connecting‚Ä¶</span>
</div>
</header>

<div style="text-align:center;margin-top:20px">
<h2 id="songTitle">Bihar FM</h2>
<p id="artistName">By Vivekfy</p>
</div>

<div style="display:flex;justify-content:center;gap:30px;margin-top:20px">
<button id="shareBtn">üîó</button>
<button id="playPauseBtn">‚ñ∂</button>
<button id="chatBtn">üí¨</button>
</div>
</div>

<div class="bottom">
<img id="coverImg" src="https://i.ibb.co/Xrv9T57F/happy-woman-listening-music-with-headphones-932695-5594.jpg" style="width:100%;height:100%;object-fit:cover">
</div>

<div id="retryOverlay">
<p>Connection lost</p>
<button id="retryBtn">Retry</button>
</div>

<!-- LONG PRESS POPUP -->
<div class="longpress-popup" id="lpPopup">
<div class="lp-box">
<h4>Dashboard</h4>
<p>Enter Correct Password</p>
<input type="password" id="lpInput" placeholder="Password">
<div class="lp-actions">
<button class="lp-cancel" id="lpCancel">Cancel</button>
<button class="lp-submit" id="lpSubmit">Open</button>
</div>
</div>
</div>

<audio id="player" autoplay></audio>

<script>
const WS_URL="wss://fmconnector.onrender.com";
const connText=document.getElementById("connText");
const player=document.getElementById("player");
const songTitle=document.getElementById("songTitle");
const artistName=document.getElementById("artistName");
const coverImg=document.getElementById("coverImg");
const retryOverlay=document.getElementById("retryOverlay");
const retryBtn=document.getElementById("retryBtn");

let ws,pc,assignedRoom;

/* üë• ROOM BADGE */
const roomBadge=document.createElement("span");
roomBadge.style.marginLeft="6px";
roomBadge.style.padding="3px 10px";
roomBadge.style.borderRadius="20px";
roomBadge.style.background="rgba(255,255,255,0.15)";
roomBadge.style.display="none";
roomBadge.style.fontSize="13px";
connText.after(roomBadge);

/* LONG PRESS */
let lpTimer;
const lpPopup=document.getElementById("lpPopup");
const lpInput=document.getElementById("lpInput");
document.body.addEventListener("touchstart",()=>{lpTimer=setTimeout(()=>lpPopup.classList.add("show"),1500)});
document.body.addEventListener("touchend",()=>clearTimeout(lpTimer));
document.getElementById("lpCancel").onclick=()=>lpPopup.classList.remove("show");
document.getElementById("lpSubmit").onclick=()=>{
  if(lpInput.value==="vk007") location.href="/cast";
  else alert("Wrong password");
};

/* WS */
function connectWS(){
ws=new WebSocket(WS_URL);
ws.onopen=()=>{
connText.textContent="Waiting‚Ä¶";
ws.send(JSON.stringify({type:"register",role:"listener"}));
};
ws.onmessage=async e=>{
const msg=JSON.parse(e.data);

if(msg.type==="room-assigned"){
assignedRoom=msg.roomId;
const num=assignedRoom.replace(/\D/g,"");
roomBadge.innerHTML=`üë• ${num}`;
roomBadge.style.display="inline-block";
}

if(msg.type==="offer"){
pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
pc.ontrack=e=>{
player.srcObject=e.streams[0];
player.play();
connText.textContent="Live";
};
pc.onicecandidate=e=>{
if(e.candidate) ws.send(JSON.stringify({type:"candidate",target:msg.from,payload:e.candidate}));
};
await pc.setRemoteDescription(msg.payload);
const ans=await pc.createAnswer();
await pc.setLocalDescription(ans);
ws.send(JSON.stringify({type:"answer",target:msg.from,payload:ans}));
}

if(msg.type==="candidate") pc.addIceCandidate(msg.payload);

if(msg.type==="metadata"){
songTitle.textContent=msg.title||"Bihar FM";
artistName.textContent=msg.artist||"Live";
if(msg.cover) coverImg.src=msg.cover;
}
};
ws.onclose=()=>retryOverlay.style.display="flex";
}
retryBtn.onclick=()=>{retryOverlay.style.display="none";connectWS()};

connectWS();
</script>
</body>
</html>
