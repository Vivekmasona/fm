<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BiharFM â€” Listener</title>
  <!-- Use your existing CSS here (don't change) -->
  <style>
    /* minimal safe styles so layout doesn't break if your css missing */
    body { font-family: system-ui, -apple-system, Roboto, Arial; margin:0; background:#071421; color:#dfeff3; }
    .top { padding:16px; display:flex; flex-direction:column; gap:12px; align-items:center; }
    .controls { display:flex; gap:12px; align-items:center; }
    .btn { width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:#0b2732;border-radius:8px; }
    .play { width:64px;height:64px;border-radius:999px;background:#00b894; }
    .cover img { width:240px;height:240px;border-radius:8px; object-fit:cover; }
    #retryOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; color:white; }
    .longpress-popup { display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#042029; padding:16px; border-radius:8px; }
    .longpress-popup.show { display:block; }
  </style>
</head>
<body>

<!-- INSTALL POPUP -->
<div class="install-popup" id="installPopup" style="display:none;">
  <div class="close-install" onclick="hideInstallPopup()">Ã—</div>
  <h3>ðŸ“» Install BiharFM App</h3>
  <p>Listen live anytime with one tap!</p>
  <button class="install-btn" id="installBtn">Install Now</button>
</div>

<div class="top">
  <header style="width:100%;display:flex;justify-content:space-between;align-items:center;">
    <div class="logo"><strong>Bihar</strong>FM</div>
    <div class="time" id="timeCounter">00:00</div>
    <div class="liveStatus"><div class="liveDot" style="width:10px;height:10px;border-radius:50%;background:#ff7675;display:inline-block;margin-right:6px;"></div><span id="connText">Connectingâ€¦</span></div>
  </header>

  <div class="song-info" style="text-align:center;">
    <h2 id="songTitle">Bihar FM</h2>
    <p id="artistName">By Vivekfy</p>
  </div>

  <div class="controls">
    <div class="btn" id="shareBtn" title="Share">
      <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a2.48 2.48 0 000-1.39l7.02-4.11A2.5 2.5 0 1014.5 5a2.5 2.5 0 00.04.42L7.52 9.53a2.5 2.5 0 100 4.94l7.02 4.11a2.5 2.5 0 102.46-2.5z"/></svg>
    </div>

    <div class="btn play" id="playPauseBtn" title="Play/Pause">
      <svg id="playIcon" viewBox="0 0 24 24" width="22" height="22"><path fill="#001" d="M8 5v14l11-7z"/></svg>
      <svg id="pauseIcon" viewBox="0 0 24 24" width="22" height="22" style="display:none;"><path fill="#001" d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>
    </div>

    <div class="btn" id="chatBtn" title="Chat">
      <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M20.52 3.48A11.85 11.85 0 0012 0C5.37 0 0 5.37 0 12a11.8 11.8 0 001.68 6.05L0 24l6.14-1.6A11.88 11.88 0 0012 24c6.63 0 12-5.37 12-12 0-3.2-1.25-6.22-3.48-8.52z"/></svg>
    </div>
  </div>
</div>

<div class="bottom" style="display:flex;justify-content:center;padding:18px;">
  <div class="cover">
    <img id="coverImg" src="https://i.ibb.co/Xrv9T57F/happy-woman-listening-music-with-headphones-932695-5594.jpg" alt="Cover">
  </div>
</div>

<!-- Retry Overlay -->
<div id="retryOverlay" style="display:none;align-items:center;justify-content:center;flex-direction:column;">
  <div style="font-size:20px;margin-bottom:12px;">Connection lost</div>
  <button id="retryBtn" style="padding:10px 16px;border-radius:8px;background:#00b894;border:0;color:#002;">Tap to Retry</button>
</div>

<!-- Longpress popup -->
<div class="longpress-popup" id="lpPopup">
  <h4 style="margin:0 0 8px 0;">Dashboard</h4>
  <p style="margin:0 0 8px 0;">Enter Correct Password</p>
  <input id="lpInput" type="password" placeholder="Password" style="width:200px;padding:8px;border-radius:6px;border:1px solid #27464a;background:#021619;color:#dfeff3;" />
  <div class="lp-actions" style="display:flex;gap:8px;margin-top:10px;">
    <button class="lp-cancel" id="lpCancel" style="padding:6px 10px;border-radius:6px;background:#333;border:0;color:#fff;">Cancel</button>
    <button class="lp-submit" id="lpSubmit" style="padding:6px 10px;border-radius:6px;background:#00b894;border:0;color:#002;">Open</button>
  </div>
</div>

<audio id="player" autoplay></audio>

<script>
/* ------------------------------
   WebRTC / Player connection
   Restored working listener script
------------------------------*/
const WS_URL = "wss://fmconnector.onrender.com";
const player = document.getElementById("player");
const connText = document.getElementById("connText");
const playBtn = document.getElementById("playPauseBtn");
const playIcon = document.getElementById("playIcon");
const pauseIcon = document.getElementById("pauseIcon");
const songTitle = document.getElementById("songTitle");
const artistName = document.getElementById("artistName");
const coverImg = document.getElementById("coverImg");
const timeCounter = document.getElementById("timeCounter");
const retryOverlay = document.getElementById("retryOverlay");
const retryBtn = document.getElementById("retryBtn");

let pc = null, playing = false;
let reconnectTimeout = null, reconnecting = false, retryCount = 0;

// update time counter
setInterval(()=>{
  if(player && !isNaN(player.currentTime)){
    const t=Math.floor(player.currentTime);
    const m=Math.floor(t/60).toString().padStart(2,"0");
    const s=(t%60).toString().padStart(2,"0");
    timeCounter.textContent=`${m}:${s}`;
  }
},1000);

function connectWS(){
  reconnecting = false;
  retryOverlay.style.display="none";
  const socket = new WebSocket(WS_URL);
  connText.textContent="Connecting";

  socket.onopen=()=>{
    // register as listener â€” server should inform broadcaster
    socket.send(JSON.stringify({type:"register",role:"listener"}));
    connText.textContent="Waiting for stream";
    retryCount = 0;
  };

  socket.onmessage=async e=>{
    const msg=JSON.parse(e.data);

    // Offer from broadcaster or mini-host
    if(msg.type==="offer"){
      connText.textContent="Connecting Stream";
      // close old pc if exists
      if(pc){ try{ pc.close(); } catch(e){} pc=null; }

      pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
      pc.ontrack=ev=>{
        try {
          player.srcObject = ev.streams[0];
          player.play().catch(()=>{});
        } catch(e){}
        connText.textContent="Live";
      };
      pc.onicecandidate=ev=>{
        if(ev.candidate) socket.send(JSON.stringify({type:"candidate",target:msg.from,payload:ev.candidate}));
      };

      try {
        await pc.setRemoteDescription(msg.payload);
        const ans=await pc.createAnswer();
        await pc.setLocalDescription(ans);
        socket.send(JSON.stringify({type:"answer",target:msg.from,payload:ans}));
      } catch (err) {
        console.warn("Failed to handle offer", err);
      }
    }

    // ICE candidate
    if(msg.type==="candidate" && pc){
      try { await pc.addIceCandidate(msg.payload).catch(()=>{}); } catch(e) {}
    }

    // metadata updates
    if(msg.type==="metadata"){
      if(msg.title) songTitle.textContent=msg.title;
      if(msg.artist) artistName.textContent=msg.artist;
      if(msg.cover) coverImg.src=msg.cover;
    }

    // server ping/pong or other handling can be here
  };

  socket.onclose=()=>handleDisconnect();
  socket.onerror=()=>handleDisconnect();
}

function handleDisconnect(){
  if(reconnecting) return;
  reconnecting = true;
  connText.textContent="Reconnecting...";
  if(pc){pc.close();pc=null;}
  if(reconnectTimeout) clearTimeout(reconnectTimeout);
  retryCount++;
  if(retryCount <= 5){ reconnectTimeout=setTimeout(()=>connectWS(),3000); }
  else retryOverlay.style.display="flex";
}

retryBtn.onclick=()=>{retryCount=0;connectWS();};

// play/pause control (local)
playBtn.onclick=async()=>{
  if(playing) player.pause();
  else { try{ await player.play(); } catch(e){} }
};

player.addEventListener("pause",()=>{
  playing=false;
  playBtn.classList.remove("playing");
  playIcon.style.display="block";
  pauseIcon.style.display="none";
});
player.addEventListener("play",()=>{
  playing=true;
  playBtn.classList.add("playing");
  playIcon.style.display="none";
  pauseIcon.style.display="block";
});

// share & chat
document.getElementById("shareBtn").onclick=()=>{
  if(navigator.share) navigator.share({title:"BiharFM Live",text:"Listen now",url:location.href});
};
document.getElementById("chatBtn").onclick = () => {
  window.open("https://wa.me/?text=ðŸŽ§ Listen BiharFM Live âžœ " + encodeURIComponent(location.href), "_blank");
};

/* ------------------------------
   LONG PRESS DASHBOARD POPUP
------------------------------*/
let lpTimer = null;
const lpPopup = document.getElementById("lpPopup");
const lpInput = document.getElementById("lpInput");
const lpCancel = document.getElementById("lpCancel");
const lpSubmit = document.getElementById("lpSubmit");

function openPopup(){ lpPopup.classList.add("show"); lpInput.focus(); }
function closePopup(){ lpPopup.classList.remove("show"); }

document.body.addEventListener("touchstart", ()=>{ lpTimer = setTimeout(openPopup, 1500); });
document.body.addEventListener("touchend", ()=>{ clearTimeout(lpTimer); });

lpCancel.onclick = closePopup;
lpSubmit.onclick = () => {
  if (lpInput.value === "vk007") {
    window.location.href = "/cast";
  } else {
    lpPopup.classList.add("wrong");
    setTimeout(()=>lpPopup.classList.remove("wrong"),400);
  }
};

/* ------------------------------
  PWA INSTALL PROMPT HANDLER (kept minimal)
------------------------------*/
let deferredPrompt;
const installPopup = document.getElementById("installPopup");
const installBtn = document.getElementById("installBtn");
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installPopup.style.display = "block";
});
installBtn && (installBtn.onclick = async () => {
  installPopup.style.display = "none";
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    if (choice.outcome === "accepted") localStorage.setItem("biharFMInstalled", "true");
    deferredPrompt = null;
  }
});
function hideInstallPopup(){ installPopup.style.display = "none"; localStorage.setItem("biharFMInstalled","true"); }

/* ------------------------------
   INIT
------------------------------*/
connectWS();
</script>

</body>
</html>
